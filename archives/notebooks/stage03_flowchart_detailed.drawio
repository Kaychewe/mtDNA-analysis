<mxfile host="app.diagrams.net" modified="2026-02-09T00:00:00.000Z" agent="Codex" version="24.7.8" type="device">
  <diagram id="stage03-detailed" name="Stage03-Detailed">
    <mxGraphModel dx="1600" dy="1200" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1400" pageHeight="1100" math="0" shadow="0">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>

        <!-- Inputs -->
        <mxCell id="in_variants" value="Stage02 variants&#xa;`split_vcf` (mt)&#xa;`split_nuc_vcf` (nuc)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFE6CC;strokeColor=#D79B00;" vertex="1" parent="1">
          <mxGeometry x="30" y="40" width="240" height="80" as="geometry"/>
        </mxCell>
        <mxCell id="in_refs" value="References + intervals&#xa;mt/ref FASTA+dict+intervals&#xa;nuc interval list" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF2CC;strokeColor=#D6B656;" vertex="1" parent="1">
          <mxGeometry x="30" y="140" width="240" height="90" as="geometry"/>
        </mxCell>
        <mxCell id="in_blacklist" value="Blacklisted sites&#xa;bed + idx" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF2CC;strokeColor=#D6B656;" vertex="1" parent="1">
          <mxGeometry x="30" y="250" width="240" height="60" as="geometry"/>
        </mxCell>
        <mxCell id="in_scripts" value="Scripts + docker images&#xa;FaRenaming + overlap/bounds&#xa;bcftools/gotc/ucsc" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF2CC;strokeColor=#D6B656;" vertex="1" parent="1">
          <mxGeometry x="30" y="330" width="240" height="90" as="geometry"/>
        </mxCell>
        <mxCell id="in_params" value="Params&#xa;`sample_name` `suffix` `n_shift`&#xa;`compute_numt_coverage`" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF2CC;strokeColor=#D6B656;" vertex="1" parent="1">
          <mxGeometry x="30" y="440" width="240" height="80" as="geometry"/>
        </mxCell>

        <!-- Core tasks -->
        <mxCell id="prep" value="PrepIntervalsAndRenamedFastas&#xa;sort intervals + extract + rename FASTA" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#DAE8FC;strokeColor=#6C8EBF;" vertex="1" parent="1">
          <mxGeometry x="320" y="80" width="260" height="80" as="geometry"/>
        </mxCell>
        <mxCell id="filter_mt" value="FilterMtVcf&#xa;homoplasmies (AF&gt;0.95)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#DAE8FC;strokeColor=#6C8EBF;" vertex="1" parent="1">
          <mxGeometry x="320" y="190" width="260" height="70" as="geometry"/>
        </mxCell>
        <mxCell id="detect_overlap" value="DetectMtOverlaps&#xa;mt vs nuc overlaps" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#DAE8FC;strokeColor=#6C8EBF;" vertex="1" parent="1">
          <mxGeometry x="320" y="280" width="260" height="70" as="geometry"/>
        </mxCell>
        <mxCell id="remove_overlap" value="RemoveMtOverlaps&#xa;remove overlapping sites" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#DAE8FC;strokeColor=#6C8EBF;" vertex="1" parent="1">
          <mxGeometry x="320" y="370" width="260" height="70" as="geometry"/>
        </mxCell>
        <mxCell id="validate_overlap" value="ValidateMtOverlaps&#xa;sanity check" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#DAE8FC;strokeColor=#6C8EBF;" vertex="1" parent="1">
          <mxGeometry x="320" y="460" width="260" height="60" as="geometry"/>
        </mxCell>

        <mxCell id="nuc_bounds" value="NucVariantBounds&#xa;reject out-of-bounds" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#DAE8FC;strokeColor=#6C8EBF;" vertex="1" parent="1">
          <mxGeometry x="610" y="260" width="240" height="70" as="geometry"/>
        </mxCell>
        <mxCell id="nuc_filter" value="FilterNucVcf&#xa;remove rejected nuc variants" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#DAE8FC;strokeColor=#6C8EBF;" vertex="1" parent="1">
          <mxGeometry x="610" y="350" width="240" height="70" as="geometry"/>
        </mxCell>

        <mxCell id="mt_consensus" value="MtConsensus&#xa;apply mt variants + chain" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#D5E8D4;strokeColor=#82B366;" vertex="1" parent="1">
          <mxGeometry x="610" y="80" width="240" height="70" as="geometry"/>
        </mxCell>
        <mxCell id="mt_finalize" value="FinalizeMtFasta&#xa;rename + dict + index" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#D5E8D4;strokeColor=#82B366;" vertex="1" parent="1">
          <mxGeometry x="610" y="160" width="240" height="70" as="geometry"/>
        </mxCell>
        <mxCell id="nuc_consensus" value="NucConsensus&#xa;apply nuc variants + chain" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#D5E8D4;strokeColor=#82B366;" vertex="1" parent="1">
          <mxGeometry x="880" y="300" width="240" height="70" as="geometry"/>
        </mxCell>
        <mxCell id="nuc_finalize" value="FinalizeNucFastas&#xa;nuc-only + nuc+mt fasta" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#D5E8D4;strokeColor=#82B366;" vertex="1" parent="1">
          <mxGeometry x="880" y="380" width="240" height="70" as="geometry"/>
        </mxCell>
        <mxCell id="shift_mt" value="ShiftMtReference&#xa;shifted mt + cat fasta + chains" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#D5E8D4;strokeColor=#82B366;" vertex="1" parent="1">
          <mxGeometry x="880" y="160" width="240" height="70" as="geometry"/>
        </mxCell>
        <mxCell id="lift_intervals" value="LiftIntervals&#xa;lift mt + non-control intervals" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#D5E8D4;strokeColor=#82B366;" vertex="1" parent="1">
          <mxGeometry x="1150" y="160" width="240" height="70" as="geometry"/>
        </mxCell>
        <mxCell id="force_call" value="ForceCallVcfs&#xa;reverse homoplasmies + shifted" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#D5E8D4;strokeColor=#82B366;" vertex="1" parent="1">
          <mxGeometry x="1150" y="240" width="240" height="70" as="geometry"/>
        </mxCell>
        <mxCell id="chain_swap" value="ChainSwapLiftoverBed&#xa;lift blacklist to self" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#D5E8D4;strokeColor=#82B366;" vertex="1" parent="1">
          <mxGeometry x="1150" y="320" width="240" height="70" as="geometry"/>
        </mxCell>

        <!-- Optional compute_numt_coverage branch -->
        <mxCell id="opt_span" value="LiftOverNucReference&#xa;CreateSpanIntervalsWithDict" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F5F5F5;strokeColor=#666666;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="880" y="470" width="240" height="70" as="geometry"/>
        </mxCell>
        <mxCell id="opt_span_shifted" value="LiftOverNucReferenceShifted&#xa;CreateSpanIntervalsWithDict" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F5F5F5;strokeColor=#666666;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="1150" y="470" width="240" height="70" as="geometry"/>
        </mxCell>
        <mxCell id="opt_chain" value="SelfToRefNucLiftoverChain&#xa;ChainSwap" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F5F5F5;strokeColor=#666666;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="1150" y="550" width="240" height="70" as="geometry"/>
        </mxCell>
        <mxCell id="opt_move" value="MoveChainToZero&#xa;normalize nuc chain" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F5F5F5;strokeColor=#666666;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="1150" y="630" width="240" height="70" as="geometry"/>
        </mxCell>

        <!-- Outputs -->
        <mxCell id="outputs" value="Outputs&#xa;self FASTAs + dicts + indexes&#xa;chains + intervals + blacklist&#xa;force-call VCFs + metrics" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFE6CC;strokeColor=#D79B00;" vertex="1" parent="1">
          <mxGeometry x="880" y="720" width="510" height="100" as="geometry"/>
        </mxCell>

        <!-- Edges -->
        <mxCell id="e1" style="endArrow=block;html=1;" edge="1" parent="1" source="in_refs" target="prep">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e2" style="endArrow=block;html=1;" edge="1" parent="1" source="in_variants" target="filter_mt">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e3" style="endArrow=block;html=1;" edge="1" parent="1" source="filter_mt" target="detect_overlap">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e4" style="endArrow=block;html=1;" edge="1" parent="1" source="detect_overlap" target="remove_overlap">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e5" style="endArrow=block;html=1;" edge="1" parent="1" source="remove_overlap" target="validate_overlap">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e6" style="endArrow=block;html=1;" edge="1" parent="1" source="remove_overlap" target="mt_consensus">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e7" style="endArrow=block;html=1;" edge="1" parent="1" source="prep" target="mt_consensus">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e8" style="endArrow=block;html=1;" edge="1" parent="1" source="mt_consensus" target="mt_finalize">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e9" style="endArrow=block;html=1;" edge="1" parent="1" source="mt_finalize" target="shift_mt">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e10" style="endArrow=block;html=1;" edge="1" parent="1" source="shift_mt" target="lift_intervals">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e11" style="endArrow=block;html=1;" edge="1" parent="1" source="remove_overlap" target="force_call">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e12" style="endArrow=block;html=1;" edge="1" parent="1" source="mt_finalize" target="force_call">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e13" style="endArrow=block;html=1;" edge="1" parent="1" source="mt_consensus" target="chain_swap">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e14" style="endArrow=block;html=1;" edge="1" parent="1" source="in_blacklist" target="chain_swap">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e15" style="endArrow=block;html=1;" edge="1" parent="1" source="in_variants" target="nuc_bounds">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e16" style="endArrow=block;html=1;" edge="1" parent="1" source="prep" target="nuc_bounds">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e17" style="endArrow=block;html=1;" edge="1" parent="1" source="nuc_bounds" target="nuc_filter">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e18" style="endArrow=block;html=1;" edge="1" parent="1" source="nuc_filter" target="nuc_consensus">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e19" style="endArrow=block;html=1;" edge="1" parent="1" source="prep" target="nuc_consensus">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e20" style="endArrow=block;html=1;" edge="1" parent="1" source="nuc_consensus" target="nuc_finalize">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e21" style="endArrow=block;html=1;" edge="1" parent="1" source="nuc_finalize" target="shift_mt">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Optional branch edges -->
        <mxCell id="e22" style="endArrow=block;html=1;dashed=1;" edge="1" parent="1" source="nuc_finalize" target="opt_span">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e23" style="endArrow=block;html=1;dashed=1;" edge="1" parent="1" source="shift_mt" target="opt_span_shifted">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e24" style="endArrow=block;html=1;dashed=1;" edge="1" parent="1" source="nuc_consensus" target="opt_chain">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e25" style="endArrow=block;html=1;dashed=1;" edge="1" parent="1" source="opt_chain" target="opt_move">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Output edges -->
        <mxCell id="e26" style="endArrow=block;html=1;" edge="1" parent="1" source="lift_intervals" target="outputs">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e27" style="endArrow=block;html=1;" edge="1" parent="1" source="force_call" target="outputs">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e28" style="endArrow=block;html=1;" edge="1" parent="1" source="chain_swap" target="outputs">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e29" style="endArrow=block;html=1;" edge="1" parent="1" source="shift_mt" target="outputs">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e30" style="endArrow=block;html=1;" edge="1" parent="1" source="nuc_finalize" target="outputs">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e31" style="endArrow=block;html=1;dashed=1;" edge="1" parent="1" source="opt_move" target="outputs">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
